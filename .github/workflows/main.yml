name: 编译 React Native iOS 应用

on:
  workflow_dispatch:  # 允许手动触发
  #push:
  #  branches: [ main ]  # 监听 main 分支推送
  #pull_request:
  #  branches: [ main ]  # 监听 PR 到 main 分支

jobs:
  build-ios:
    runs-on: macos-latest  # 必须使用 macOS 环境

    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 配置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x  # 匹配项目的 Node 版本
          cache: 'yarn'       # 或 'npm'，根据项目包管理器选择

      - name: 安装前端依赖
        run: |
          yarn install --update-checksums
          # 或 npm install  yarn install --frozen-lockfile
          # 安装 pods 前先导航到 ios 目录
          # cd ios
      - name: 清除 CocoaPods 缓存并安装依赖  and save logs
        run: |
          cd ios
          # pod cache clean --all  # 清除所有缓存
          # rm -rf Podfile.lock Pods  # 清除本地依赖
          pod install --verbose > pod_install_full.log 2>&1
        # pod install --verbose  # 详细日志模式，便于排查

      #- name: 安装 CocoaPods 依赖 # 清除所有缓存
      #  run: |
      #    cd ios
      #    pod install  # 安装 iOS 原生依赖
     # 清除本地依赖
     # pod cache clean --all  
     #     rm -rf Podfile.lock Pods 
    # 详细日志模式，便于排查
      - name: 编译 Debug 版本（模拟器）
        run: |
          cd ios
          # 使用 xcodebuild 编译模拟器版本（无需证书）
          xcodebuild build -workspace AwesomeProject.xcworkspace \
            -scheme AwesomeProject \
            -configuration Debug \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM=""  \
            -quiet \
        # -verbose > xcode_build_full.log 2>&1
      - name: Upload log artifacts 上传日志
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs # Artifact名称
          path: | # 要上传的日志文件路径
            ios/pod_install_full.log
            ios/xcode_build_full.log
          retention-days: 7 # 日志保留7天，可按需调整